buffer.save(view,null);
thisFile = buffer.getPath();
mpwFile = new File(thisFile);
parentDirectory = mpwFile.getParent();
templateFile = new File(parentDirectory + java.io.File.separator + "html_template.mpw");

try
{
    exerciseFoldsMap = org.mathpiper.test.MPWSFile.getFoldsMap(mpwFile.getPath(), new java.io.FileInputStream(mpwFile));
    templateFoldsMap = org.mathpiper.test.MPWSFile.getFoldsMap(mpwFile.getPath(), new java.io.FileInputStream(templateFile));
    prologue = templateFoldsMap.get("prologue").getContents();
    premarkdown = templateFoldsMap.get("preexplanation").getContents();
    markdownFold = exerciseFoldsMap.get("explanation");
    exerciseCode = exerciseFoldsMap.get("exerciseCode").getContents();
    if(exerciseCode == null) 
    {
        exerciseCode = "";
    }
    outputFileName = markdownFold.getAttributes().get("output");
    markdown = markdownFold.getContents();
    markdown = markdown.replace("\\","\\\\");
    util = ua.pico.jedit.markdown.MarkdownUtil.getInstance();
    processor = util.getProcessor();
    htmlText = processor.markdownToHtml(markdown);
    postmarkdown = templateFoldsMap.get("postexplanation").getContents();
    epilogue = templateFoldsMap.get("epilogue").getContents();
    combined = prologue + premarkdown + htmlText + postmarkdown + exerciseCode + epilogue;
    outputFilePath = parentDirectory + java.io.File.separator + outputFileName;
    if(outputFilePath.contains("\\")) //For windows.
    {
        outputFilePath = outputFilePath.substring(3,outputFilePath.length());
    }
    outputURI = new java.net.URI("file:///" + outputFilePath.replaceAll(" ", "%20").replaceAll("\\\\","/"));  
    File outputFile = new File(outputURI);
    BufferedWriter htmlFileWriter = new BufferedWriter(new FileWriter(outputFile,false));
	htmlFileWriter.write(combined);
	htmlFileWriter.close();
    
}
catch(Throwable e)
{
    e.printStackTrace();
}

